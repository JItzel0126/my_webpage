<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout}">

<!-- í˜ì´ì§€ ì „ìš© head ì¶”ê°€ -->
<th:block layout:fragment="pageHead">
    <title>ì‹œë¦¬ì¦ˆ | Papaya Novel</title>
    <!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
          crossorigin="anonymous">
</th:block>


<div layout:fragment="content">
    <div class="mt-2 mx-auto w-full sm:w-11/12">

        <section class="flex gap-6 p-4 border rounded-lg shadow-sm">
            <div class="w-32 h-44 overflow-hidden rounded-md border">
                <img th:src="${series.fileUrl}" alt="ì±… í‘œì§€"
                     class="w-full h-full object-cover"/>
            </div>
            <div class="flex-1">
                <h3 th:text="${series.title}" class="text-xl font-bold mb-1"></h3>
                <p th:text="${series.author}" class="text-sm text-gray-600 mb-1"></p>
                <p th:text="${series.publisher}" class="text-sm text-gray-600 mb-1"></p>
                <p class="text-yellow-500 mb-2">â­ í‰ì  4.9 (13,753ëª…)</p>
                <div class="flex gap-2">
                    <a class="px-3 py-1 bg-indigo-500 text-white rounded hover:bg-indigo-600">ì²«í™”ë³´ê¸°</a>
                    <button class="px-3 py-1 border rounded hover:bg-gray-100">ì¥ë°”êµ¬ë‹ˆ</button>
                </div>
            </div>
            <div class="text-2xl">ğŸ¤</div>
        </section>

        <article class="mt-6 p-4 border rounded-lg shadow-sm bg-gray-50">
            <h3 class="text-lg font-semibold mb-2">ğŸ’¬ ì‘í’ˆ ì†Œê°œ</h3>

            <p th:text="${series.description}" class="text-gray-700 leading-relaxed line-clamp-3"></p>

            <button class="mt-2 text-sm text-indigo-500 hover:underline">ë”ë³´ê¸° âŒ„</button>
        </article>

        <section class="mt-6">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-semibold">ğŸ“– íšŒì°¨ ëª©ë¡</h3>
                <form method="get" th:action="@{'/series/'+${series.id}}">
                <select name="sort" onchange="this.form.submit()" class="border rounded px-2 py-1 text-sm">
                    <option value="desc" th:selected="${sort == null or sort == 'desc'}">ìµœì‹ ìˆœ</option>
                    <option value="asc" th:selected="${sort == 'asc'}">1í™”ë¶€í„°</option>
                </select>
                </form>
            </div>

            <div>
                <ul th:each="ep : ${series.episode}"  class="divide-y border rounded shadow-sm" id="episodeList">
                    <a th:href="@{'/episode/'+${ep.id}}">
                        <li class="p-3 hover:bg-gray-50 cursor-pointer flex flex-row justify-between">
                            <span th:text="${ep.epiNumber} +'í™” - ' + ${ep.epiTitle}"></span>
                            <span class="ml-2 text-sm text-gray-500" th:text="${ep.price} + 'ì›'"></span>
                        </li>
                    </a>
                </ul>
            </div>
        </section>



        <!-- ëŒ“ê¸€ ì˜ì—­ -->
        <section class="mt-6">
            <div class="flex flex-row justify-between items-center">

        <h3 class="font-bold">ëŒ“ê¸€ëª©ë¡</h3>

        <select id="sortSelect" class="form-select w-auto d-inline shadow-sm" aria-label="Default select example">
            <option value="desc">ìµœì‹ ìˆœ</option>
            <option value="asc">ì˜¤ë˜ëœìˆœ</option>
        </select>
            </div>

        <div class="input-group shadow-sm mt-2">
            <input type="text" id="commentInput" class="form-control" placeholder="ëŒ“ê¸€ ì“°ê¸°"/>
            <button id="commentBtn" class="btn btn-primary">ë“±ë¡</button>
        </div>

        <div class="border-2 rounded shadow-sm my-2 p-2">
            <ul id="commentList" class="list-group mb-3">
                <button id="delBtn" class="btn btn-sm btn-outline-danger">ì‚­ì œ</button>
            </ul>
        </div>
        </section>

    </div>


</div>

<!-- boardDetail.html -->
<th:block layout:fragment="extraScript">
    <!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
            crossorigin="anonymous"></script>

    <script th:inline="javascript">
<!--  TODO: 1) ì„œë²„ì—ì„œ Thymeleafë¡œ series.idë¥¼ ì£¼ì… -->

    // TODO: ì˜ˆ) /series/1 -> seriesId = 1;
        const seriesId = [[${series.Id}]];
    // TODO : sort="desc"ë¥¼ ê¸°ë³¸ ë§¤ê°œë³€ìˆ˜ë¡œ ì§€ì •
    async function loadComments(sort = "desc") {
        try {
    // TODO: 2) JS fetch("/ncomments/{id}?sort=desc") í˜¸ì¶œ â†’ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ JSON ë°˜í™˜
            const response = await fetch(`/ncomments/${seriesId}?sort=${sort}`);
            if (!response.ok) {
                throw new Error("ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
            }
            const comments = await response.json();

    //  TODO: 3) ë°›ì•„ì˜¨ JSONìœ¼ë¡œ <ul id="commentList"> ì•ˆì— li ìƒì„±
            const list = document.getElementById("commentList");
            list.innerHTML = "";

            comments.forEach((c) => {
                const li = document.createElement("li");
                li.className = "list-group-item d-flex justify-content-between align-items-center";
                li.innerHTML = `
    <span class="text-gray-800">
      ${c.content} <span class="text-sm text-gray-500">(${c.writer})</span>
    </span>
    <button class="text-red-500 hover:text-red-700 text-sm">ì‚­ì œ</button>
  `;

                li.querySelector("button").onclick = () => deleteComment(c.ncno);

                list.appendChild(li);
            });
        } catch (e) {
            console.error(e);
        }
    }

//     ì‚­ì œ
    async function deleteComment(ncno) {
    const response = await fetch(`/ncomments/${ncno}`, {
        method: "DELETE"
    });

    if (response.ok) {
        loadComments(); // ì‚­ì œ í›„ ëª©ë¡ ê°±ì‹ 
    } else {
        alert("ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨ ğŸ˜­");
    }
}

    // ì •ë ¬ ì˜µì…˜ì´ ë°”ë€” ë•Œ
const sortSelect = document.getElementById("sortSelect");
    sortSelect.addEventListener("change", (event) => {
        loadComments(event.target.value); })




// ëŒ“ê¸€ ë“±ë¡
document.getElementById("commentBtn").addEventListener("click", async () => {
    const content = document.getElementById("commentInput").value.trim();
    if (!content) {
        alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        return;
    }

    // Spring Security CSRF í† í° (ë©”íƒ€ íƒœê·¸ë‚˜ ìˆ¨ê¹€ inputì—ì„œ êº¼ë‚´ê¸°)
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content || "X-CSRF-TOKEN";
    const csrfToken  = document.querySelector('meta[name="_csrf"]')?.content
        || document.querySelector('input[name="_csrf"]')?.value;

    const response = await fetch("/ncomments", {
        method: "POST",
        headers: { "Content-Type": "application/json" ,
        ...(csrfToken ? { [csrfHeader]: csrfToken } : {})
        },
        body : JSON.stringify({
            id: seriesId,
            content: content,
        })
    });

    if (response.ok) {
        document.getElementById("commentInput").value = "";
        loadComments();
    } else {
        alert("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨ ğŸ˜­");
    }
});

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ìµœì‹ ìˆœìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
    loadComments();

    </script>
</th:block>

</html>